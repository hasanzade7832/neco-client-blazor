@using MudBlazor
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web

@if (Visible)
{
    <div class="tm-overlay" @onclick="CloseAsync" @onkeydown="OnKeyDown" tabindex="0" @ref="_overlayRef">
        <div class="tm-dialog @( _isClosing ? "closing" : null )"
             style="@PanelStyle"
             @onclick:stopPropagation="true">

            <!-- ===== هدر ===== -->
            <div class="tm-header">
                <div class="tm-title">TaskManageMent</div>
                <div class="tm-actions">
                    <MudIconButton Icon="@(_maximized ? Icons.Material.Filled.FullscreenExit : Icons.Material.Filled.Fullscreen)"
                                   Class="tm-icon"
                                   Size="Size.Large"
                                   Variant="Variant.Text"
                                   OnClick="ToggleMaximize" />
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Class="tm-icon"
                                   Size="Size.Large"
                                   Variant="Variant.Text"
                                   OnClick="CloseAsync" />
                </div>
            </div>

            <!-- ===== بادی ===== -->
            <div class="tm-dialog-body">
                <!-- ناحیه‌ی ۸ خطی: سایدبار + مین‌بار (با فاصله‌ی کم از خط هدر و خط پایین) -->
                <div class="tm-rail-8lines">
                    <aside class="tm-sidebar">
                        <div style="font-weight:600;margin-bottom:6px;">Sidebar</div>
                        <div style="opacity:.8;font-size:.925rem;">light blue area</div>
                    </aside>

                    <main class="tm-main">
                        <div style="font-weight:700;font-size:20px;margin-bottom:6px;">Main bar</div>
                        <div style="opacity:.9;">اینجا محتوای اصلی مدیریت تسک‌ها قرار می‌گیرد.</div>
                    </main>
                </div>

                <!-- خط جداکننده زیر ناحیه‌ی ۸ خطی -->
                <div class="tm-divider"></div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public bool MaximizedInitial { get; set; } = true;

    private bool _maximized = true;
    private bool _isClosing = false;
    private ElementReference _overlayRef;

    protected override void OnParametersSet()
    {
        if (Visible) _maximized = MaximizedInitial;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Visible) { try { await _overlayRef.FocusAsync(); } catch { } }
    }

    private async Task CloseAsync()
    {
        if (_isClosing) return;
        _isClosing = true;
        await Task.Delay(180);
        _isClosing = false;
        await OnClose.InvokeAsync();
    }

    private void ToggleMaximize() => _maximized = !_maximized;

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape") await CloseAsync();
    }

    private string PanelStyle => _maximized
        ? "width: calc(100% - 32px); height: calc(100% - 32px); margin: 16px;"
        : "width: 50%; height: 50%; min-width: 480px; min-height: 320px;";
}

<style>
    :root {
        --tm-line: 1.5rem;
    }
    /* یک خط = 1.5rem → 8 خط = 12rem */

    /* اوورلی (فقط محدوده‌ی پدر/جدول را می‌پوشاند) */
    .tm-overlay {
        position: absolute;
        inset: 0;
        z-index: 10;
        background: rgba(0,0,0,.35);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .tm-dialog {
        position: relative;
        background: #d9d9d9;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0,0,0,.35), 0 8px 20px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.12);
        display: flex;
        flex-direction: column;
        transition: width .22s cubic-bezier(.2,.8,.2,1), height .22s cubic-bezier(.2,.8,.2,1), margin .22s cubic-bezier(.2,.8,.2,1), transform .22s cubic-bezier(.2,.8,.2,1), opacity .22s ease;
        animation: dialog-in .22s cubic-bezier(.2,.8,.2,1);
    }

        .tm-dialog.closing {
            animation: dialog-out .18s ease forwards;
        }

    /* هدر (خط بالا در border-bottom همین هدر است) */
    .tm-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 14px;
        border-bottom: 1px solid rgba(0,0,0,.08);
        background: #d9d9d9;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .tm-title {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
    }

    .tm-actions {
        display: flex;
        gap: 8px;
    }

    .tm-icon {
        color: #000 !important;
        filter: drop-shadow(0 1px 1px rgba(255,255,255,.35));
    }

    /* بادی (ستونی) */
    .tm-dialog-body {
        flex: 1 1 auto;
        overflow: auto;
        padding: 16px;
        min-height: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* ناحیه‌ی ۸ خطی: دقیقاً 8 * line-height */
    .tm-rail-8lines {
        height: calc(var(--tm-line) * 8); /* ارتفاع دقیق ۸ خط */
        display: flex;
        align-items: stretch;
        gap: 12px;
        margin: 8px 8px; /* فاصله‌ی ملایم از خط هدر و خط پایین + چپ/راست */
    }

    .tm-sidebar {
        flex: 0 0 280px;
        max-width: 320px;
        height: 100%;
        background: #eaf3ff;
        border-radius: 10px;
        padding: 12px;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,.04);
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .tm-main {
        flex: 1 1 auto;
        height: 100%;
        background: #f8fafc;
        border-radius: 10px;
        padding: 12px;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,.04);
        display: flex;
        flex-direction: column;
        min-height: 0;
        min-width: 0;
    }

    /* خط پایین بعد از ناحیه‌ی ۸ خطی */
    .tm-divider {
        height: 1px;
        background: rgba(0,0,0,.12);
        margin: 0 8px;
    }

    /* ریسپانسیو - در موبایل کنارهم‌بودن تبدیل به ستونی می‌شود اما همان ارتفاع ۸ خط حفظ می‌شود */
    @@media (max-width: 768px) {
        .tm-rail-8lines

    {
        flex-direction: column;
    }

    .tm-sidebar {
        flex: 1 1 auto;
        max-width: none;
    }

    }

    /* Razor escape برای keyframes */
    @@keyframes dialog-in {
        from {
            transform: scale(.92);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    @@keyframes dialog-out {
        from {
            transform: scale(1);
            opacity: 1;
        }

        to {
            transform: scale(.92);
            opacity: 0;
        }
    }
</style>
