@* =======================
   taskmanagement.razor
   ======================= *@

@using MudBlazor
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web

@if (Visible)
{
    <div class="tm-overlay" @onclick="CloseAsync" @onkeydown="OnKeyDown" tabindex="0" @ref="_overlayRef">
        <div class="tm-dialog @( _isClosing ? "closing" : null )"
             style="@PanelStyle"
             @onclick:stopPropagation="true">

            <!-- ===== هدر ===== -->
            <div class="tm-header">
                <div class="tm-title">TaskManageMent</div>
                <div class="tm-actions">
                    <MudIconButton Icon="@(_maximized ? Icons.Material.Filled.FullscreenExit : Icons.Material.Filled.Fullscreen)"
                                   Class="tm-icon"
                                   Size="Size.Large"
                                   Variant="Variant.Text"
                                   OnClick="ToggleMaximize" />
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Class="tm-icon"
                                   Size="Size.Large"
                                   Variant="Variant.Text"
                                   OnClick="CloseAsync" />
                </div>
            </div>

            <!-- ===== بادی ===== -->
            <div class="tm-dialog-body">
                <div class="tm-rail-8lines">
                    <aside class="tm-sidebar">
                        <!-- === آواتار ادمک وسط‌چین === -->
                        <div class="tm-role-card">
                            <div class="tm-avatar">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Class="tm-avatar-icon" />
                            </div>
                            <div class="tm-role-caption">Role</div>
                        </div>
                    </aside>

                    <main class="tm-main">
                        <div class="tm-main-headline">
                            Execute Related Text for Post for Issue and Fill in Form, Please.
                        </div>

                        <!-- ===== مستطیل با بردر نازک سیاه زیر تیتر — دقیقا وسط‌چین ===== -->
                        <div class="tm-exec-panel" role="group" aria-label="Execute Panel">
                            <!-- باکس قرمز: دو قسمت زیر هم طبق تصویر 1 -->
                            <div class="tm-exec-left">
                                <div class="tm-left-stack">
                                    <!-- کارت 1: Project IV با بک‌گراند #d9d9d9 -->
                                    <div class="tm-card">
                                        <div class="tm-project-title">Project IV</div>
                                    </div>

                                    <!-- کارت 2: دکمه Action با بک‌گراند #d9d9d9 -->
                                    <div class="tm-card" style="display:flex;justify-content:center;">
                                        <MudButton Class="tm-action-btn" Variant="Variant.Filled">Action</MudButton>
                                    </div>
                                </div>
                            </div>

                            <!-- باکس سبز: چهار نوشته زیر هم طبق تصویر 2 -->
                            <div class="tm-exec-right">
                                <div class="tm-meta-list" aria-label="Meta List">
                                    <div>Status</div>
                                    <div>Send Date</div>
                                    <div>Due Date</div>
                                    <div>Class</div>
                                </div>
                            </div>
                        </div>
                        <!-- ===== پایان مستطیل ===== -->
                    </main>
                </div>

                <div class="tm-divider"></div>

                <!-- ===== ناحیه‌ی جدید زیر خط: باکس کوچک قرمز چپ، باکس سه‌تکه راست ===== -->
                <div class="tm-after-line">
                    <!-- باکس کوچک قرمز سمت چپ با اسکیل 1/3 -->
                    <div class="tm-mini-left" aria-label="Small Red Box"></div>

                    <!-- باکس سه‌تکه سمت راست؛ سه باکس کنار هم، هر کدام 1/3 کل
                         و اندازه‌ی هر کدام = 1/3 اندازه‌ی قبلی (کاهش 2/3) -->
                    <div class="tm-mini-right" aria-label="Three Segment Box">
                        <div class="tm-mini-seg tm-seg-purple"></div>
                        <div class="tm-mini-seg tm-seg-yellow"></div>
                        <div class="tm-mini-seg tm-seg-orange"></div>
                    </div>
                </div>
                <!-- ===== پایان ناحیه جدید ===== -->

            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public bool MaximizedInitial { get; set; } = true;

    private bool _maximized = true;
    private bool _isClosing = false;
    private ElementReference _overlayRef;

    protected override void OnParametersSet()
    {
        if (Visible) _maximized = MaximizedInitial;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Visible) { try { await _overlayRef.FocusAsync(); } catch { } }
    }

    private async Task CloseAsync()
    {
        if (_isClosing) return;
        _isClosing = true;
        await Task.Delay(180);
        _isClosing = false;
        await OnClose.InvokeAsync();
    }

    private void ToggleMaximize() => _maximized = !_maximized;

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape") await CloseAsync();
    }

    private string PanelStyle => _maximized
        ? "width: calc(100% - 32px); height: calc(100% - 32px); margin: 16px;"
        : "width: 50%; height: 50%; min-width: 480px; min-height: 320px;";
}
