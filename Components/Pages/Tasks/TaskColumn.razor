@using MudBlazor
@using BlazorApp12.Models
@using Microsoft.AspNetCore.Components.Web

<div style="@($"flex:0 0 {(Collapsed ? CollapsedWidth : ExpandedWidth)}px;width:{(Collapsed ? CollapsedWidth : ExpandedWidth)}px;display:flex;flex-direction:column;border-radius:12px;overflow:hidden;position:relative;background-color:{BackgroundCss};transition:width .25s ease,flex-basis .25s ease;")">
    @if (!Collapsed)
    {
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;">
            <div style="font-weight:600;font-size:1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">@Title</div>

            <!-- دکمه جمع‌شونده + سه‌نقطه در سمت راست آن -->
            <div style="display:flex;align-items:center;gap:8px;">
                <MudIconButton Icon="@Icons.Material.Filled.KeyboardDoubleArrowLeft"
                               OnClick="Toggle"
                               Style="color:var(--mud-palette-text-primary);font-size:24px;" />

                <MudIconButton Icon="@Icons.Material.Filled.MoreHoriz"
                               Style="font-size:22px;color:var(--mud-palette-text-primary);margin:0;padding:4px;"
                               OnClick="OpenHeaderMenu" />
            </div>
        </div>

        <div class="task-scroll" style="flex:1;overflow-y:auto;padding:0 8px 12px;box-sizing:border-box;">
            @{
                var list = Items?.ToList() ?? new();
                for (int i = 0; i < list.Count; i++)
                {
                    var handler = (GlassOnSecond && i == 1)
                        ? EventCallback.Factory.Create<MouseEventArgs>(this, OpenOverlay)
                        : EventCallback<MouseEventArgs>.Empty;

                    <TaskCard Item="list[i]" MenuClicked="handler" />
                }
            }
        </div>
    }
    else
    {
        <div style="position:absolute;top:6px;right:6px;">
            <MudIconButton Icon="@Icons.Material.Filled.KeyboardDoubleArrowRight"
                           OnClick="Toggle"
                           Style="color:var(--mud-palette-text-primary);font-size:24px;" />
        </div>
        <div style="flex:1;display:flex;align-items:center;justify-content:center;">
            <div style="transform:rotate(-90deg);font-weight:700;font-size:1.1rem;color:rgba(0,0,0,.55);letter-spacing:.5px;white-space:nowrap;">@Title</div>
        </div>
    }
</div>

@if (_overlayOpen || _headerMenuOpen)
{
    <!-- بک‌دراپ برای بستن هر دو منو -->
    <div style="position:fixed;inset:0;z-index:19;background:transparent;" @onclick="CloseAll"></div>
}

<!-- منوی شیشه‌ای کارت Done (روی کلیک منو داخل کارت) -->
@if (_overlayOpen)
{
    <div class="task-scroll"
         style="@($"position:fixed;left:{_overlayX}px;top:{_overlayY}px;z-index:20;")
                background:rgba(120,120,120,.18);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
                border-radius:12px;border:1px solid rgba(255,255,255,.35);
                box-shadow:0 8px 24px rgba(0,0,0,.25);padding:8px 0;min-width:240px;
                max-height:320px;overflow-y:auto;">
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;">
            <MudIcon Icon="@Icons.Material.Filled.SubdirectoryArrowRight" Style="opacity:.9;" />
            <span style="font-weight:600;">Follow Up</span>
        </div>
        <div style="height:1px;background:rgba(0,0,0,.08);margin:0 12px;"></div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;">
            <MudIcon Icon="@Icons.Material.Filled.Notifications" Style="opacity:.9;" />
            <span style="font-weight:600;">Alert</span>
        </div>
        <div style="height:1px;background:rgba(0,0,0,.08);margin:0 12px;"></div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;">
            <MudIcon Icon="@Icons.Material.Filled.DoubleArrow" Style="opacity:.9;" />
            <span style="font-weight:600;">Expedite</span>
        </div>
        <div style="height:1px;background:rgba(0,0,0,.08);margin:0 12px;"></div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;">
            <MudIcon Icon="@Icons.Material.Filled.Groups" Style="opacity:.9;" />
            <span style="font-weight:600;">Consult</span>
        </div>
        <div style="height:1px;background:rgba(0,0,0,.08);margin:0 12px;"></div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;">
            <MudIcon Icon="@Icons.Material.Filled.ChangeCircle" Style="opacity:.9;" />
            <span style="font-weight:600;">Reassign</span>
        </div>
    </div>
}

<!-- منوی شیشه‌ای هدر ستون: Properties / Sort با همان استایل -->
@if (_headerMenuOpen)
{
    <div class="task-scroll"
         style="@($"position:fixed;left:{_headerX}px;top:{_headerY}px;z-index:21;")
                background:rgba(120,120,120,.18);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
                border-radius:12px;border:1px solid rgba(255,255,255,.35);
                box-shadow:0 8px 24px rgba(0,0,0,.25);padding:8px 0;min-width:220px;
                max-height:260px;overflow-y:auto;">
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;">
            <MudIcon Icon="@Icons.Material.Filled.Tune" Style="opacity:.9;" />
            <span style="font-weight:600;">Properties</span>
        </div>
        <div style="height:1px;background:rgba(0,0,0,.08);margin:0 12px;"></div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;">
            <MudIcon Icon="@Icons.Material.Filled.Sort" Style="opacity:.9;" />
            <span style="font-weight:600;">Sort</span>
        </div>
    </div>
}

@code{
    [Parameter] public string Title { get; set; } = "";
    [Parameter] public IEnumerable<TaskItem> Items { get; set; } = Array.Empty<TaskItem>();
    [Parameter] public bool Collapsed { get; set; }
    [Parameter] public EventCallback<bool> CollapsedChanged { get; set; }
    [Parameter] public string BackgroundCss { get; set; } = "var(--mud-palette-action-default)";
    [Parameter] public int ExpandedWidth { get; set; } = 280;
    [Parameter] public int CollapsedWidth { get; set; } = 64;
    [Parameter] public bool GlassOnSecond { get; set; }

    void Toggle() => CollapsedChanged.InvokeAsync(!Collapsed);

    bool _overlayOpen;
    double _overlayX;
    double _overlayY;

    bool _headerMenuOpen;
    double _headerX;
    double _headerY;

    void OpenOverlay(MouseEventArgs e)
    {
        _overlayX = e.ClientX + 12;
        _overlayY = e.ClientY + 10;
        _overlayOpen = true;
        StateHasChanged();
    }

    void OpenHeaderMenu(MouseEventArgs e)
    {
        _headerX = e.ClientX + 8;
        _headerY = e.ClientY + 8;   // دقیقاً زیر سه‌نقطه
        _headerMenuOpen = true;
        StateHasChanged();
    }

    void CloseAll()
    {
        _overlayOpen = false;
        _headerMenuOpen = false;
    }
}
